# Sabine Agent Monitoring Infrastructure

This directory contains the configuration for monitoring the Sabine Agent using Prometheus and Grafana.

## Overview

The monitoring stack consists of:
- **Prometheus**: Time-series database that scrapes metrics from the Sabine API
- **Grafana**: Visualization platform with pre-configured dashboards

## Prerequisites

- Docker and Docker Compose installed
- Sabine Agent API running on port 8000 (localhost)

## Setup Instructions

### 1. Start the Sabine API

Make sure the Sabine Agent API is running on port 8000:

```bash
# From the project root
python run_server.py
```

The API exposes metrics at `http://localhost:8000/metrics/prometheus`.

### 2. Start the Monitoring Stack

From the `infra` directory, run:

```bash
docker compose -f docker-compose.monitoring.yml up -d
```

This will:
- Start Prometheus on port 9090
- Start Grafana on port 3000
- Auto-provision the Prometheus datasource
- Auto-provision the Sabine Overview dashboard

### 3. Access Grafana

1. Open your browser to http://localhost:3000
2. Login with:
   - **Username**: `admin`
   - **Password**: `sabine`
3. Navigate to **Dashboards** → **Sabine Agent Overview**

The dashboard will automatically refresh every 30 seconds and shows the last 6 hours of data.

## Dashboard Panels

The **Sabine Agent Overview** dashboard includes 8 panels in a 2x4 grid:

### Row 1: Queue Health
- **Queue Depth**: Time series showing queued and in-progress tasks
- **Blocked Tasks**: Current count of tasks blocked by failed dependencies (red if > 0)
- **Stuck Tasks**: Tasks that have exceeded timeout (red if > 0)
- **Stale Tasks**: Bar gauge showing tasks queued too long (1h and 24h thresholds)

### Row 2: Performance
- **Success Rate (1h)**: Gauge showing task success rate 0-100% (green/yellow/red zones)
- **Completed vs Failed**: Time series comparing completed and failed tasks
- **Task Duration**: Time series showing average and P95 task duration in milliseconds
- **Pending Retries**: Count of failed tasks pending retry (yellow > 0, red > 5)

## Metrics Available

The following Prometheus metrics are scraped from `/metrics/prometheus`:

- `dream_team_queue_depth{status="queued|in_progress"}` - Number of tasks in queue by status
- `dream_team_blocked_tasks` - Tasks blocked by failed dependencies
- `dream_team_stuck_tasks` - Tasks stuck past timeout
- `dream_team_stale_tasks{threshold="1h|24h"}` - Tasks queued too long
- `dream_team_pending_retries` - Failed tasks pending retry
- `dream_team_success_rate_1h` - Task success rate in last hour (0-100)
- `dream_team_completed_1h` - Tasks completed in last hour
- `dream_team_failed_1h` - Tasks failed in last hour
- `dream_team_task_duration_ms{quantile="avg|p95"}` - Task duration statistics

## Accessing Prometheus

Prometheus is available at http://localhost:9090. You can:
- Query metrics using PromQL
- Check scrape targets status at http://localhost:9090/targets
- View the Prometheus configuration

## Teardown

To stop the monitoring stack:

```bash
docker compose -f docker-compose.monitoring.yml down
```

To stop and remove all data (including historical metrics):

```bash
docker compose -f docker-compose.monitoring.yml down -v
```

## Data Persistence

Metrics and dashboard data are stored in Docker volumes:
- `prometheus_data`: Prometheus time-series data
- `grafana_data`: Grafana settings and user data

These volumes persist across container restarts. To clear all data, use the `-v` flag when running `docker compose down`.

## Troubleshooting

### Prometheus Not Scraping

1. Check that the Sabine API is running: `curl http://localhost:8000/metrics/prometheus`
2. Check Prometheus targets: http://localhost:9090/targets
3. Verify Docker can reach the host: `host.docker.internal` should resolve to your host machine

### Dashboard Shows No Data

1. Ensure Prometheus is successfully scraping (check targets page)
2. Check the time range in Grafana (default is last 6 hours)
3. Verify metrics are being generated by the API (check `/metrics/prometheus` endpoint)
4. Call `POST /metrics/record` to record a metrics snapshot if needed

### Grafana Dashboard Not Auto-Provisioning

1. Check that the dashboard file exists: `infra/grafana/dashboards/sabine-overview.json`
2. Check provisioning logs: `docker logs sabine-grafana`
3. Manually import the dashboard: **Dashboard** → **Import** → Upload JSON file

## Configuration Files

- `prometheus.yml`: Prometheus scrape configuration
- `grafana/provisioning/datasources/prometheus.yml`: Prometheus datasource config
- `grafana/provisioning/dashboards/dashboard.yml`: Dashboard provisioning config
- `grafana/dashboards/sabine-overview.json`: Dashboard JSON definition
- `docker-compose.monitoring.yml`: Docker Compose stack definition
